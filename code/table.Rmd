---
title: "Explorative Analyse"
author: "Johannes Brachem"
date: "29.08.2019"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r imports, include=FALSE}
library(tidyverse)
library(lme4)
source("code/helper_functions.R")

t <- readRDS("data/exploration/analysis_tables.rds")
an1 <- readRDS("data/exploration/an1.rds")
an2 <- readRDS("data/exploration/an2.rds")
meta <- readRDS("data/exploration/meta.rds")
```

```{r definitions, include=FALSE}
n <- meta$proj.aggregated %>% pull(n) %>% sum()
n.out <- meta$proj.aggregated %>% filter(uni == "_unclear") %>% pull(n)
n.in <- meta$proj.aggregated %>% filter(uni == "clear") %>% pull(n)
n.obs1 <- meta$nrow1
n.obs2 <- meta$nrow2

lr1.1 <- an1[[1]][[4]]
lr1.2 <- an1[[1]][[5]]
m1.1 <- an1[[1]][[2]]
m1.2 <- an1[[1]][[3]]

lr2.1 <- an2[[1]][[4]]
lr2.2 <- an2[[1]][[5]]
m2.1 <- an2[[1]][[2]]
m2.2 <- an2[[1]][[3]]

v1.1 <- VarCorr(m1.1)$id %>% as.numeric() %>% round(2) %>% format(nsmall = 2)
v2.1 <- VarCorr(m2.1)$id %>% as.numeric() %>% round(2) %>% format(nsmall = 2)

v1.2 <- VarCorr(m1.2)$uni_project %>% as.numeric() %>% round(2) %>% format(nsmall = 2)
v2.2 <- VarCorr(m2.2)$uni_project %>% as.numeric() %>% round(2) %>% format(nsmall = 2)

df1.1 <- lr1.1$`Chi Df`[2]
df1.2 <- lr1.2$`Chi Df`[2]
df2.1 <- lr2.1$`Chi Df`[2]
df2.2 <- lr2.2$`Chi Df`[2]

chi1.1 <- lr1.1$Chisq[2] %>% round(2) %>% format(nsmall = 2)
chi1.2 <- lr1.2$Chisq[2] %>% round(2) %>% format(nsmall = 2)
chi2.1 <- lr2.1$Chisq[2] %>% round(2) %>% format(nsmall = 2)
chi2.2 <- lr2.2$Chisq[2] %>% round(2) %>% format(nsmall = 2)

p1.1 <- format_p(lr1.1)
p1.2 <- format_p(lr1.2)
p2.1 <- format_p(lr2.1)
p2.2 <- format_p(lr2.2)

asd <- "[placeholder]"
```


# Fragwürdige Forschungspraktiken

Generalisiertes Lineares Gemischtes Modell mit dichotomer Abhängiger Variable und logit Link-Funktion. 
Die Abhängige Variable ist ein Indikator dafür, ob eine Forschungspraktik in einem Projekt angewandt wurde. 
Zugrunde liegen Daten über `r n` Projekte. Daten von Projekten, für die die zugehörige Universität nicht eindeutig identifiziert werden konnte, wurden nicht in die Analyse aufgenommen. Betroffen waren `r n.out` Projekte, so dass schließlich Daten von `r n.in` Projekten in die Analyse aufgenommen werden konnten. Pro Projekt enthält der Datensatz Antworten bzgl. neun verschiedener fragwürdiger Forschungspraktiken. Insgesamt ergeben sich daraus `r n.obs1` Beobachtungspunkte.

Das Modell enthält zwei random intercepts: Je einen für den/die jeweilige/n Teilnehmer\*in und einen für die Universität, an der das Projekt durchgeführt wurde. Es zeigte sich signifikante Varianz zwischen Teilnehmer\*innen, SD = `r v1.1`, $\chi^2$ (`r df1.1`) = `r chi1.1`, `r p1.1` und zwischen den Universitäten, SD = `r v1.2`, $\chi^2$ (`r df1.2`) = `r chi1.2`, `r p1.2`. Da ein/e Teilnehmer*in durch einen Wechsel der Universität beim Wechsel vom Bachelor- zum Master-Studium mehreren Universitäten zugeordnet sein kann, wurden die zufälligen Effekte nicht aus genestete, sondern als gekreuzte Effekte in das Modell aufgenommen. 

Von Interesse ist insbesondere das Effektstärkemaß Odds Ratio (OR, Chancenverältnis). Ein OR > 1 deutet bei numerischen Prädiktoren darauf hin, dass die Chance, dass eine Forschungspraktik angewandt wird, bei einem höheren Wert des Prädiktors zunimmt. Ein OR < 1 deutet daruf hin, dass diese Chance bei höherem Wert des Prädiktors abnimmt.

Bei kategorialen Prädiktoren gibt das OR das Chancenverhältnis im Vergleich zur jeweiligen Referenzkategorie an. Ein OR > 1 bedeutet, dass die Chance im Vergleich zur Referenzkategorie höher ist, ein OR < 1, dass sie geringer ist.

```{r table_qrps}
knitr::kable(t[[1]][,2:8],
             caption = "Schätzungen der fixen Effekte für fragwürdige Forschungspraktiken. Abhängige Variable: Forschungspraktik angewendet (0 – Nein, 1 – Ja).")
```

# Positive Forschungspraktiken

Generalisiertes Lineares Gemischtes Modell mit dichotomer Abhängiger Variable und logit Link-Funktion. 
Die Abhängige Variable ist ein Indikator dafür, ob eine Forschungspraktik in einem Projekt angewandt wurde. 
Die Anzahl eingeschlossener Projekte ist gegenüber der Analyse der fragwürdigen Forschungspraktiken unveränert. Pro Projekt enthält der Datensatz Antworten bzgl. zwei verschiedener positiver Forschungspraktiken. Insgesamt ergeben sich daraus `r n.obs2` Beobachtungspunkte.

Das Modell enthält zwei random intercepts: Je einen für den/die jeweilige/n Teilnehmer\*in und einen für die Universität, an der das Projekt durchgeführt wurde. Es zeigte sich signifikante Varianz zwischen Teilnehmer\*innen, SD = `r v2.1`, $\chi^2$ (`r df2.1`) = `r chi2.1`, `r p2.1` und zwischen den Universitäten, SD = `r v2.2`, $\chi^2$ (`r df2.2`)=`r chi2.2`, `r p2.2`. Da ein/e Teilnehmer*in durch einen Wechsel der Universität beim Wechsel vom Bachelor- zum Master-Studium mehreren Universitäten zugeordnet sein kann, wurden die zufälligen Effekte nicht aus genestete, sondern als gekreuzte Effekte in das Modell aufgenommen. 

Von Interesse ist insbesondere das Effektstärkemaß Odds Ratio (OR, Chancenverältnis). Ein OR > 1 deutet bei numerischen Prädiktoren darauf hin, dass die Chance, dass eine Forschungspraktik angewandt wird, bei einem höheren Wert des Prädiktors zunimmt. Ein OR < 1 deutet daruf hin, dass diese Chance bei höherem Wert des Prädiktors abnimmt.

Bei kategorialen Prädiktoren gibt das OR das Chancenverhältnis im Vergleich zur jeweiligen Referenzkategorie an. Ein OR > 1 bedeutet, dass die Chance im Vergleich zur Referenzkategorie höher ist, ein OR < 1, dass sie geringer ist.

```{r table_orps}
knitr::kable(t[[2]][,2:8],
             caption = "Schätzungen der fixen Effekte für positive Forschungspraktiken. Abhängige Variable: Forschungspraktik angewendet (0 – Nein, 1 – Ja).")
```

```{r}
source("code/packages.R")
source("code/helper_functions.R")
source("code/static.R")

d <- read_csv("data/df_practices.csv")
ex <- readRDS("data/exploration.rds")
t1 <- ex$qrp$models$m3 %>% glmer_table(names = na1)


ft1 <- glue::glue("Anmerkungen. N = {ex$data$qrp %>% nrow() %>% format(big.mark = ' ')}")
ft2 <- "Referenzkategorien: Weiblich (Geschlecht), Bachelor (Studienfortschritt), Nein (OSI an der Uni), Nein (OSI bekannt), Ja (RK gelehrt), Nein (Praktik gelehrt), Fehlende Stichprobenplanung (QRP), Expra (Projekt)"

ft2 %>% as_paragraph()
# \n \nAbkürzungen: OSI – Open Science Initiative, RK – Replikationskrise, QRP – Questionable Research practice [Fragwürdige Forschungspraktik], SB – Selektives Berichten, B – Beta-Gewicht, SE – Standard Error [Standardfehler], OR – Odds Ratio [Chancenverhältnis], KI - Konfidenzintervall\n * p < {t1$alpha[1]}, ** p < {t1$alpha[2]}, *** p < {t1$alpha[2]} (adjustierte Alpha-Niveaus nach Bonferroni)")
# 
# print(ft)


t1$table %>% 
  select(-1) %>% 
  print(n = nrow(.)) %>% 
  mutate_at(c(2, 3, 4, 6), co) %>% 
  flextable() %>% align(j = c(1,7), align = "left", part = "body") %>% 
  align(j = 1, align= "left", part = "header") %>% 
  add_footer_lines(ft1) %>% 
  add_footer_lines(ft2) %>% autofit()
```





