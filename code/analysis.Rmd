---
title: "Analysis - Part 1"
subtitle: "PsyFaKo Open Science Survey"
author: "Johannes Brachem"
date: "Last update: `r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    number_sections: yes
    theme: journal
    toc: yes
    toc_depth: 2
    toc_float: 
      collapsed: false
---

# Header
## Load Packages
```{r packages}
# library(formr)
library(tidyverse)
# library(lubridate)
# library(knitr)
# library(kableExtra)
# library(glue)
# library(skimr)
```

## Session Info
```{r session info}
sessionInfo()
```

## Import Data

```{r import data}
main <- read_csv("data/main.csv") %>% 
  filter(field_of_study_mc == "Psychology" | study_degree_field == "Psychology") %>% 
  filter(emp_experience == "Yes")

df_practices <- read_csv("data/df_practices.csv")%>% 
  filter(field_of_study_mc == "Psychology" | study_degree_field == "Psychology") %>% 
  filter(emp_experience == "Yes")
```

# Question Block 2: Research Practices

```{r}
n_projects_total <- df_practices %>% 
  distinct(id, n_projects) %>% 
  summarise(n = sum(n_projects, na.rm = TRUE)) %>% 
  pull(n)
```


## Preregistered Analyses

**Note**: In our preregistration, we only specified analyses for questionable research practices. Because it might be of interest, we also calculate the same figures for the two open research practices that we asked about. One should be very careful to compare both types of practices here directly, because the number of questionable research practices that we asked about was a lot higher (9), than the number of open practices that we asked about (2). So, e.g. a difference of 1.3 questionable practices applied per project on average, compared to only 0.5 open practices is almost certainly confounded by the number of specific practices that were assessed.

### Full Aggregation

#### Mean Number of QRPs and ORPs applied per Project per Participant
The chunk below first sums up, how many QRPs and ORPs were totally applied by each participant. Then, theses sums are each divided by the total number of projects conducted by each participant, returning the average number of QRPs / ORPs applied per project.

```{r eval=FALSE, include=FALSE}
# Total scores: Total number of RP applications divided by total number of projects 
# (not preregistered, not included in output)

q01.0 <- df_practices %>% 
  group_by(type_of_practice) %>% 
  summarise(n = sum(rp_applied, na.rm = TRUE)) %>% 
  ungroup() %>% 
  mutate(n_projects = n_projects_total) %>% 
  mutate(practices_per_project = n / n_projects_total)

q01.0
```

```{r}
# Mean over individual scores: Number of RP applications per project,
# averaged across individuals (preregistered)

q01 <- df_practices %>% 
  # number of applied practices (per individual and type of project)
  group_by(id, type_of_practice, n_projects) %>% 
  summarise(applied_practices = sum(rp_applied, na.rm = TRUE)) %>% 
  ungroup() %>% 
  mutate(practices_per_project = applied_practices / n_projects) %>% 
  
  # average over individuals
  group_by(type_of_practice) %>% 
  summarise(m = mean(practices_per_project),
            sd = sd(practices_per_project))

q01
```

### Project Aggregation

How many open/questionable research practices were applied on average per project?

```{r}
q02 <- df_practices %>% 
  group_by(id, type_of_practice, project, project_conducted) %>% 
  summarise(n_practice_appl = sum(rp_applied)) %>% 
  ungroup() %>% 
  group_by(type_of_practice, project) %>% 
  summarise(mean = mean(n_practice_appl, na.rm = TRUE), # mean number of applied practices per project
            sd = sd(n_practice_appl, na.rm = TRUE), # sd for number of applied practices per project
            n_conducted = sum(project_conducted), # number of conducted projects
            n_applied = sum(n_practice_appl, na.rm=TRUE)) # number of practice applications

q02
```


### Practice Aggregation
For every practice, we compute the share of participants who applied that practice *at least one* in any project. We only include participants who have conducted at least one empirical research project.

```{r}
q03 <- df_practices %>% 
  filter(rp_applied) %>% 
  group_by(practice, type_of_practice) %>% 
  summarise(n = n_distinct(id)) %>% 
  mutate(n_vp = nrow(main)) %>% 
  mutate(share = (n / n_vp)*100) %>% 
  arrange(share %>% desc()) %>% 
  identity()

# print
q03
```

### Detailed Practice Aggregation

```{r}
n_projects <- df_practices %>% 
  ungroup() %>% 
  distinct(id, project, project_conducted) %>% 
  group_by(project) %>% 
  summarise(n = sum(project_conducted)) %>% 
  mutate(order = c(1, 5, 2, 3, 4)) %>% 
  arrange(order)

df_practices$n_project <- rep(n_projects$n, times = nrow(df_practices) / 5)

q04 <- df_practices %>% 
  ungroup() %>% 
  group_by(practice, type_of_practice, project, n_project) %>% 
  summarise(n = sum(rp_applied, na.rm = TRUE)) %>% 
  mutate(share = (n / n_project)*100) %>% 
  arrange(type_of_practice) %>% 
  identity()

# print
q04 %>% print(n = nrow(.))
```

## Platforms for Preregistration
`prereg_where` contains the answers to the question "Which platform did you use for your preregistration?". Multiple answers where possible. They are coded:

answer | meaning
-------|----------
1 | preregistration given to lecturer
2 | aspredicted.org
3 | osf.io
4 | journal
5 | other
6 | I never preregistered

```{r}
prereg_where <- main %>% 
  pull(prereg_where)

prereg_counts <- as.character(1:6) %>% 
  map_dbl(function(x) prereg_where %>% str_count(x) %>% sum(na.rm=T))

names_prereg_where <- c("lecturer", "aspredicted.org", "osf.io", 
                        "journal", "other", "never preregistered")

(prereg_where_data <- tibble(names_prereg_where, prereg_counts))
```

```{r}
prereg_where_data %>% 
  ggplot(aes(x = fct_reorder(names_prereg_where, 
                             prereg_counts), 
             y = prereg_counts)) +
  geom_bar(stat = "identity", aes(fill = names_prereg_where)) +
  labs(x = "Platform", y = "Number of registrations",
       title = "Platforms used for preregistration",
       fill = "Platform") +
  coord_flip() +
  theme_classic() +
  theme(legend.position = "none") +
  # theme_fivethirtyeight() +
  # ggthemes::theme_solarized() + 
  NULL
```

## Non-registered Analyses

### Share of practice applications
For each practice, we look at the share of projects in which the respective practice was applied.
```{r}
# 
q05 <- df_practices %>% 
  # filter(project %contains% "thesis.bsc" | project %contains% "thesis.msc") %>% 
  filter(rp_applied) %>% 
  group_by(practice, type_of_practice) %>% 
  summarise(n_applied = n()) %>% 
  mutate(n_projects_total = n_projects_total) %>% 
  mutate(share = (n_applied / n_projects_total)*100) %>% 
  arrange(share %>% desc())

q05
```

### Open Science Initiatives

```{r}
nosi_q <- df_practices %>% 
  # number of applied practices (per individual and type of project)
  group_by(id, type_of_practice, n_projects, nosi_at_uni) %>% 
  summarise(applied_practices = sum(rp_applied, na.rm = TRUE)) %>% 
  ungroup() %>% 
  mutate(practices_per_project = applied_practices / n_projects) 
  
  # average over individuals
nosi_q %>%
  group_by(type_of_practice, nosi_at_uni) %>% 
  summarise(m = mean(practices_per_project),
            sd = sd(practices_per_project))
```

# Save Results
```{r}
block2 <- list(q01 = q01, 
                    q02 = q02, 
                    q03 = q03, 
                    q04 = q04, 
                    q05 = q05,
               prereg_data = prereg_where_data)

saveRDS(block2, "data/block2_results.rds")
```







